{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import { Plugin, ResolvedConfig } from 'vite'\r\nimport { minify, Options } from 'html-minifier-terser'\r\nimport { glob } from 'glob'\r\nimport { readFile, writeFile } from 'fs/promises'\r\nimport { normalize } from 'path'\r\n\r\nconst PLUGIN_NAME = 'vite-plugin-minify'\r\n\r\nexport function ViteMinifyPlugin(options?: Options): Plugin {\r\n  let config: ResolvedConfig\r\n\r\n  return {\r\n    name: PLUGIN_NAME,\r\n    enforce: 'post',\r\n    apply: 'build',\r\n    configResolved: resolvedConfig => {\r\n      config = resolvedConfig\r\n    },\r\n    closeBundle: () => {\r\n      glob(normalize(`${config.build.outDir}/**/*.html`).replace(/\\\\/g, '/'), (err, files) => {\r\n        if (err) {\r\n          return console.error(`[${PLUGIN_NAME}]`, err)\r\n        }\r\n        files.forEach(async file => {\r\n          try {\r\n            const buffer = await readFile(file, { encoding: 'utf-8' })\r\n            const minified = await minify(buffer.toString(), {\r\n              removeComments: true,\r\n              collapseWhitespace: true,\r\n              collapseBooleanAttributes: true,\r\n              removeAttributeQuotes: false,\r\n              removeEmptyAttributes: true,\r\n              minifyCSS: true,\r\n              minifyJS: true,\r\n              minifyURLs: true,\r\n              ...options,\r\n            })\r\n            await writeFile(file, minified, 'utf-8')\r\n            console.log(`[${PLUGIN_NAME}]`, `minified ${file}`)\r\n          } catch (e) {\r\n            console.error(`[${PLUGIN_NAME}]`, e)\r\n          }\r\n        })\r\n      })\r\n    },\r\n  }\r\n}\r\n\r\nexport default ViteMinifyPlugin\r\n"],"mappings":"yVACA,8CACA,4BACA,sDACA,iCAEA,GAAM,GAAc,qBAEb,WAA0B,EAA2B,CAC1D,GAAI,GAEJ,MAAO,CACL,KAAM,EACN,QAAS,OACT,MAAO,QACP,eAAgB,GAAkB,CAChC,EAAS,CACX,EACA,YAAa,IAAM,CACjB,EAAK,EAAU,GAAG,EAAO,MAAM,kBAAkB,EAAE,QAAQ,MAAO,GAAG,EAAG,CAAC,EAAK,IAAU,CACtF,GAAI,EACF,MAAO,SAAQ,MAAM,IAAI,KAAgB,CAAG,EAE9C,EAAM,QAAQ,KAAM,IAAQ,CAC1B,GAAI,CACF,GAAM,GAAS,KAAM,GAAS,EAAM,CAAE,SAAU,OAAQ,CAAC,EACnD,EAAW,KAAM,GAAO,EAAO,SAAS,EAAG,GAC/C,eAAgB,GAChB,mBAAoB,GACpB,0BAA2B,GAC3B,sBAAuB,GACvB,sBAAuB,GACvB,UAAW,GACX,SAAU,GACV,WAAY,IACT,EACJ,EACD,KAAM,GAAU,EAAM,EAAU,OAAO,EACvC,QAAQ,IAAI,IAAI,KAAgB,YAAY,GAAM,CACpD,OAAS,EAAP,CACA,QAAQ,MAAM,IAAI,KAAgB,CAAC,CACrC,CACF,CAAC,CACH,CAAC,CACH,CACF,CACF,CAEA,GAAO,GAAQ","names":[]}