{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import { Plugin, ResolvedConfig } from 'vite'\nimport { minify, Options } from 'html-minifier-terser'\nimport { join } from 'path'\nimport { glob } from 'glob'\nimport { readFile, writeFile } from 'fs/promises'\n\nconst PLUGIN_NAME = 'vite-plugin-minify'\n\nexport function ViteMinifyPlugin(options?: Options): Plugin {\n  let config: ResolvedConfig\n\n  return {\n    name: PLUGIN_NAME,\n    enforce: 'post',\n    apply: 'build',\n    configResolved: resolvedConfig => {\n      config = resolvedConfig\n    },\n    closeBundle: () => {\n      glob(join(config.build.outDir, '**', '*.html'), (err, files) => {\n        if (err) {\n          return console.error(`[${PLUGIN_NAME}]`, err)\n        }\n        files.forEach(async file => {\n          try {\n            const buffer = await readFile(file, { encoding: 'utf-8' })\n            const minified = await minify(buffer.toString(), {\n              removeComments: true,\n              collapseWhitespace: true,\n              collapseBooleanAttributes: true,\n              removeAttributeQuotes: false,\n              removeEmptyAttributes: true,\n              minifyCSS: true,\n              minifyJS: true,\n              minifyURLs: true,\n              ...options,\n            })\n            await writeFile(file, minified, 'utf-8')\n            console.log(`[${PLUGIN_NAME}]`, `minified ${file}`)\n          } catch (e) {\n            console.error(`[${PLUGIN_NAME}]`, e)\n          }\n        })\n      })\n    },\n  }\n}\n\nexport default ViteMinifyPlugin\n"],"mappings":"yVACA,8CACA,4BACA,4BACA,sDAEA,GAAM,GAAc,qBAEb,WAA0B,EAA2B,CAC1D,GAAI,GAEJ,MAAO,CACL,KAAM,EACN,QAAS,OACT,MAAO,QACP,eAAgB,GAAkB,CAChC,EAAS,CACX,EACA,YAAa,IAAM,CACjB,EAAK,EAAK,EAAO,MAAM,OAAQ,KAAM,QAAQ,EAAG,CAAC,EAAK,IAAU,CAC9D,GAAI,EACF,MAAO,SAAQ,MAAM,IAAI,KAAgB,CAAG,EAE9C,EAAM,QAAQ,KAAM,IAAQ,CAC1B,GAAI,CACF,GAAM,GAAS,KAAM,GAAS,EAAM,CAAE,SAAU,OAAQ,CAAC,EACnD,EAAW,KAAM,GAAO,EAAO,SAAS,EAAG,GAC/C,eAAgB,GAChB,mBAAoB,GACpB,0BAA2B,GAC3B,sBAAuB,GACvB,sBAAuB,GACvB,UAAW,GACX,SAAU,GACV,WAAY,IACT,EACJ,EACD,KAAM,GAAU,EAAM,EAAU,OAAO,EACvC,QAAQ,IAAI,IAAI,KAAgB,YAAY,GAAM,CACpD,OAAS,EAAP,CACA,QAAQ,MAAM,IAAI,KAAgB,CAAC,CACrC,CACF,CAAC,CACH,CAAC,CACH,CACF,CACF,CAEA,GAAO,GAAQ","names":[]}